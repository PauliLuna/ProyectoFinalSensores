<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sensores</title>
    <link rel="stylesheet" href="styles/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
</head>
<body class="body-loading">
    <!-- Left and Top menu -->
    <div id="sidebar-container"></div>
    <div id="top-banner-container"></div>

    <!-- Main Content -->
    <div class="main-content">
        <div><h1>Sensores por Ubicación – Estado Actual</h1></div>
        <div id="map"></div>
        <script>
            const map = L.map('map').setView([-32.9442, -60.6505], 12); // Ejemplo: Rosario

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);

            fetch('/sensores')
                .then(res => res.json())
                .then(sensores => {
                    // Define los iconos personalizados
                    const blueIcon = new L.Icon({
                        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png',
                        shadowUrl: 'https://unpkg.com/leaflet@1.9.3/dist/images/marker-shadow.png',
                        iconSize: [25, 41],
                        iconAnchor: [12, 41],
                        popupAnchor: [1, -34],
                        shadowSize: [41, 41]
                    });
                    const redIcon = new L.Icon({
                        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
                        shadowUrl: 'https://unpkg.com/leaflet@1.9.3/dist/images/marker-shadow.png',
                        iconSize: [25, 41],
                        iconAnchor: [12, 41],
                        popupAnchor: [1, -34],
                        shadowSize: [41, 41]
                    });

                    const markers = L.markerClusterGroup({
                        iconCreateFunction: function(cluster) {
                            // Obtén todos los marcadores hijos del cluster
                            const childMarkers = cluster.getAllChildMarkers();
                            // Si alguno está fuera de rango, el cluster será rojo
                            const anyOutOfRange = childMarkers.some(marker => marker.options.icon.options.iconUrl.includes('red'));
                            // Usa el icono rojo si alguno está fuera de rango, azul si todos en rango
                            const clusterClass = anyOutOfRange ? 'marker-cluster-red' : 'marker-cluster-blue';
                            return L.divIcon({
                                html: `<div><span>${cluster.getChildCount()}</span></div>`,
                                className: `marker-cluster ${clusterClass}`,
                                iconSize: L.point(40, 40)
                            });
                        }
                    });

                    sensores.forEach(sensor => {
                        if (sensor.latitud && sensor.longitud) {
                            const icon = sensor.enRango ? blueIcon : redIcon;
                            const marker = L.marker([sensor.latitud, sensor.longitud], { icon });
                            marker.bindPopup(
                                `<b>${sensor.alias || 'Sensor ' + sensor.nroSensor}</b><br>
                                Temp. Interna: ${sensor.temperaturaInterna !== null && sensor.temperaturaInterna !== undefined ? sensor.temperaturaInterna + '°C' : '-- °C'}`
                            );
                            markers.addLayer(marker);
                        }
                    });
                    map.addLayer(markers);
                })
                .catch(err => {
                    console.error('Error al cargar sensores:', err);
                });

            map.on('click', function(e) {
            const popup = L.popup()
                .setLatLng(e.latlng)
                .setContent("Ubicación: " + e.latlng.toString())
                .openOn(map);
            });
        </script>
    </div>
    <script src="scripts/utils.js"></script>
</body>
</html>